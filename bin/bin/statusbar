#!/bin/bash

# ========== [config] ==========

bar_padding_left=$(printf "%2s")
bar_padding_right=$(printf "%2s")

i3_workspace_icon=$(printf "\\ue9a2");
i3_workspace_base_color="#4DD0E1";
i3_workspace_active_color="#EC407A";
i3_workspace_separator=$(printf "%2s")

time_icon=$(printf "\\ue939")
time_icon_color="#EC7875"

# ========== [utils] ==========

function get_i3_workspaces {
    i3-msg -t get_workspaces | jq '.[].num';
}

function get_i3_current_workspace {
    i3-msg -t get_workspaces | jq '.[] | select(.focused == true).num';
}

function get_current_time {
    date "+%H:%M:%S"
}

# ========== [format] ==========

function format_i3_workspaces {
    i3_all_workspaces=$(get_i3_workspaces);
    i3_current_workspace=$(get_i3_current_workspace)

    index="0"
    result="";

    for wspace in $i3_all_workspaces; do
        fmt_wspace="$i3_workspace_icon $wspace";

        # check if workspace is active
        if [ "$wspace" -eq "$i3_current_workspace" ]; then
            fmt_wspace="%{F${i3_workspace_active_color}}$fmt_wspace"
        else
            fmt_wspace="%{F${i3_workspace_base_color}}$fmt_wspace"
        fi

        if [ "$index" -eq "0" ]; then
            result="$fmt_wspace";
        else
            result="$result$i3_workspace_separator$fmt_wspace";
        fi

        index=$(expr $index + 1)
    done;

    echo "$result%{F-}";
}

function format_time {
    echo "%{F$time_icon_color}$time_icon%{F-} $(get_current_time)"
}

# ========== [main] ==========

function statusbar_format_single {
    workspaces=$(format_i3_workspaces)
    current_time=$(format_time)

    result="%{l}$bar_padding_left$workspaces"
    result="$result %{r}$current_time$bar_padding_right"

    echo "$result"
}

function statusbar_format_loop {
    while true
    do
        statusbar_format_single
        sleep 0.1
    done
}

function main {
    statusbar_format_loop | \
        lemonbar \
            -B "#FF181818" \
            -F "#FFEBDBB2" \
            -g "x30" \
            -f "feather:size=12" \
            -f "UbuntuMono Nerd Font:size=11"
}

main
